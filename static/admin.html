<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Second Chair Login</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Spectral:wght@400;700&family=Satoshi:wght@400;700&display=swap">
<link rel="stylesheet" href="/static/styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        


        h1, h2, h3, h4, h5, h6 {
            font-family: 'Spectral', serif;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #000;
        }
        
        .login-box {
            background: var(--white);
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
        }
        
        .login-box h2 {
            text-align: center;
            margin-bottom: 30px;
            font-family: 'Satoshi', sans-serif;
            font-size: 125%;
            background: linear-gradient(90deg, rgb(8, 131, 253) 0%, rgb(35, 137, 253) 0%, rgb(140, 209, 251) 100%);
            -webkit-background-clip: text;
            color: transparent;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--gray-600);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: var(--primary);
            color: var(--white);
            text-decoration: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            text-align: center;
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .btn.btn-full {
            width: 100%;
        }
        
        .btn.btn-secondary {
            background: var(--secondary);
        }
        
        .btn.btn-danger {
            background: var(--danger);
        }
        
        .btn.btn-warning {
            background: var(--warning);
        }
        
        .btn.btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn.btn-outline:hover {
            background: var(--primary);
            color: var(--white);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .error {
            color: var(--danger);
            font-size: 14px;
            margin-top: 8px;
        }
        
        .success {
            color: var(--secondary);
            font-size: 14px;
            margin-top: 8px;
        }
        
        /* Main Interface */
        .header {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: var(--primary);
            font-size: 28px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nav-tabs {
            display: flex;
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            text-align: center;
        }
        
        .nav-tab:hover {
            background: var(--gray-100);
        }
        
        .nav-tab.active {
            background: var(--primary);
            color: var(--white);
        }
        
        .content-panel {
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            border-left: 4px solid var(--primary);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Tenants and Agents */
        .tenant-card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .tenant-header {
            background: var(--primary);
            color: var(--white);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tenant-body {
            padding: 20px;
        }
        
        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .agent-card {
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .agent-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .agent-name {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 8px;
        }
        
        .agent-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-ready {
            background: var(--secondary);
            color: var(--white);
        }
        
        .status-needs-data {
            background: var(--warning);
            color: var(--white);
        }
        
        .agent-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }
        
        th {
            background: var(--gray-100);
            font-weight: 600;
            color: var(--gray-800);
        }
        
        tr:hover {
            background: var(--gray-100);
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: var(--white);
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-800);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-600);
        }
        
        /* Form styling */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .color-input {
            width: 60px !important;
            height: 40px;
            padding: 4px;
            border-radius: 4px;
        }
        
        /* Widget Configuration */
        .widget-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .config-section {
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 20px;
        }
        
        .config-section h4 {
            margin-bottom: 15px;
            color: var(--primary);
            border-bottom: 2px solid var(--gray-200);
            padding-bottom: 8px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .widget-config {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h2>Second Chair Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-full">
                    <span id="loginSpinner" class="spinner hidden"></span>
                    Login
                </button>
                <div id="loginError" class="error hidden"></div>
            </form>
        </div>
    </div>

    <!-- Main Interface -->
    <div id="mainInterface" class="hidden">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>CQ Second Chair Administration</h1>
                <div class="user-info">
                    <span id="userWelcome">Welcome, User!</span>
                    <button id="logoutBtn" class="btn btn-danger">Logout</button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="dashboard">📊 Dashboard</button>
                <button class="nav-tab" data-tab="tenants">🏢 Tenants & Agents</button>
                <button class="nav-tab" data-tab="users">👥 Users</button>
                <button class="nav-tab" data-tab="analytics">📈 Analytics</button>
                <button class="nav-tab" data-tab="settings">⚙️ Settings</button>
                <button class="nav-tab" data-tab="styling">🎨 Styling</button>
            </div>

            <!-- Dashboard Panel -->
            <div id="dashboardPanel" class="content-panel">
                <h2>System Overview</h2>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalTenants">0</div>
                        <div class="stat-label">Tenants</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalAgents">0</div>
                        <div class="stat-label">Agents</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalChats">0</div>
                        <div class="stat-label">Total Chats</div>
                    </div>
                </div>
            </div>

            <!-- Tenants Panel -->
            <div id="tenantsPanel" class="content-panel hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Tenants & Agents</h2>
                    <button id="createTenantBtn" class="btn">+ Create Tenant</button>
                </div>
                <div id="tenantsContainer"></div>
            </div>

            <!-- Users Panel -->
            <div id="usersPanel" class="content-panel hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>User Management</h2>
                    <button id="createUserBtn" class="btn">+ Create User</button>
                </div>
                <div class="table-container">
                    <table id="usersTable">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Tenant</th>
                                <th>Agents</th>
                                <th>Role</th>
                                <th>File Permissions</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Panel -->
            <div id="analyticsPanel" class="content-panel hidden">
                <h2>Analytics</h2>
                <div id="analyticsContent">
                    <p>Select a tenant to view analytics:</p>
                    <select id="analyticsTenant" class="form-group">
                        <option value="">Select Tenant</option>
                    </select>
                    <div id="analyticsResults" class="hidden"></div>
                </div>
            </div>

            <!-- Settings Panel -->
            <div id="settingsPanel" class="content-panel hidden">
                <h2>System Settings</h2>
                <div class="form-group">
                    <label>System Status</label>
                    <div id="systemStatus"></div>
                </div>
                <div class="form-group">
                    <button id="llmTestBtn" class="btn">Test LLM Connections</button>
                    <div id="llmTestResult" style="margin-top:8px;"></div>
                </div>
                <div class="form-group">
                    <button id="llmLogsBtn" class="btn">Show LLM Logs</button>
                    <div id="llmLogs" class="hidden"></div>
                </div>
                <div class="form-group">
                    <label for="userTimeout">User Timeout (minutes)</label>
                    <input type="number" id="userTimeout" min="1" value="30" style="width:80px;">
            </div>
        </div>
            <!-- Styling Panel -->
            <div id="stylingPanel" class="content-panel hidden">
                <h2>Styling</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="primary">Primary Color</label>
                        <input type="color" id="primary">
                    </div>
                    <div class="form-group">
                        <label for="primaryDark">Primary Dark</label>
                        <input type="color" id="primaryDark">
                    </div>
                    <div class="form-group">
                        <label for="secondary">Secondary Color</label>
                        <input type="color" id="secondary">
                    </div>
                    <div class="form-group">
                        <label for="danger">Danger Color</label>
                        <input type="color" id="danger">
                    </div>
                    <div class="form-group">
                        <label for="warning">Warning Color</label>
                        <input type="color" id="warning">
                    </div>
                    <div class="form-group">
                        <label for="bodyFontSize">Body Font Size (px)</label>
                        <input type="number" id="bodyFontSize" min="12" max="24" style="width:80px;">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="footerBg">Footer Color</label>
                        <input type="color" id="footerBg">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="logoUrl">Footer Logo URL</label>
                        <input type="text" id="logoUrl">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="footerLink1Text">Link 1 Text</label>
                        <input type="text" id="footerLink1Text">
                    </div>
                    <div class="form-group">
                        <label for="footerLink1Url">Link 1 URL</label>
                        <input type="text" id="footerLink1Url">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="footerLink2Text">Link 2 Text</label>
                        <input type="text" id="footerLink2Text">
                    </div>
                    <div class="form-group">
                        <label for="footerLink2Url">Link 2 URL</label>
                        <input type="text" id="footerLink2Url">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="footerLink3Text">Link 3 Text</label>
                        <input type="text" id="footerLink3Text">
                    </div>
                    <div class="form-group">
                        <label for="footerLink3Url">Link 3 URL</label>
                        <input type="text" id="footerLink3Url">
                    </div>
                </div>
            </div>
    </div>

    <!-- Modals -->
    
    <!-- Create Tenant Modal -->
    <div id="createTenantModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Tenant</h3>
                <button class="close-btn" onclick="closeModal('createTenantModal')">&times;</button>
            </div>
            <form id="createTenantForm">
                <div class="form-group">
                    <label for="tenantName">Tenant Name</label>
                    <input type="text" id="tenantName" name="tenantName" required>
                </div>
                <div class="form-group">
                    <label for="agentName">Initial Agent Name</label>
                    <input type="text" id="agentName" name="agentName" value="support" required>
                </div>
                <button type="submit" class="btn">Create Tenant</button>
            </form>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="createUserModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New User</h3>
                <button class="close-btn" onclick="closeModal('createUserModal')">&times;</button>
            </div>
            <form id="createUserForm">
                <div class="form-group">
                    <label for="newUsername">Username</label>
                    <input type="text" id="newUsername" name="username" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">Password</label>
                    <input type="password" id="newPassword" name="password" required>
                </div>
                <div class="form-group">
                    <label for="newUserTenant">Tenant</label>
                    <select id="newUserTenant" name="tenant" required>
                        <option value="*">All Tenants (Admin)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newUserAgent">Agent</label>
                    <select id="newUserAgent" name="agent" required>
                        <option value="*">All Agents</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newUserRole">Role</label>
                    <select id="newUserRole" name="role" required>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newUserLanguage">Language</label>
                    <select id="newUserLanguage" name="language">
                        <option value="English">English</option>
                        <option value="Spanish">Spanish</option>
                        <option value="Chinese (Simplified)">Chinese (Simplified)</option>
                        <option value="Korean">Korean</option>
                        <option value="Arabic">Arabic</option>
                        <option value="Hindi">Hindi</option>
                        <option value="Japanese">Japanese</option>
                        <option value="French">French</option>
                        <option value="German">German</option>
                        <option value="Portuguese (Brazil)">Portuguese (Brazil)</option>
                        <option value="Italian">Italian</option>
                        <option value="Bengali">Bengali</option>
                        <option value="Indonesian">Indonesian</option>
                        <option value="Swahili">Swahili</option>
                    </select>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="newUserFiles" name="allow_files">
                    <label for="newUserFiles">File Permissions</label>
                </div>
                <button type="submit" class="btn">Create User</button>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit User</h3>
                <button class="close-btn" onclick="closeModal('editUserModal')">&times;</button>
            </div>
            <form id="editUserForm">
                <div class="form-group">
                    <label for="editUsername">Username</label>
                    <input type="text" id="editUsername" name="username" readonly>
                </div>
                <div class="form-group">
                    <label for="editPassword">Password</label>
                    <input type="password" id="editPassword" name="password" placeholder="Leave blank to keep current">
                </div>
                <div class="form-group">
                    <label for="editUserTenant">Tenant</label>
                    <select id="editUserTenant" name="tenant"></select>
                </div>
                <div class="form-group">
                    <label for="editUserAgent">Agent</label>
                    <select id="editUserAgent" name="agent"></select>
                </div>
                <div class="form-group">
                    <label for="editUserRole">Role</label>
                    <select id="editUserRole" name="role">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editUserLanguage">Language</label>
                    <select id="editUserLanguage" name="language">
                        <option value="English">English</option>
                        <option value="Spanish">Spanish</option>
                        <option value="Chinese (Simplified)">Chinese (Simplified)</option>
                        <option value="Korean">Korean</option>
                        <option value="Arabic">Arabic</option>
                        <option value="Hindi">Hindi</option>
                        <option value="Japanese">Japanese</option>
                        <option value="French">French</option>
                        <option value="German">German</option>
                        <option value="Portuguese (Brazil)">Portuguese (Brazil)</option>
                        <option value="Italian">Italian</option>
                        <option value="Bengali">Bengali</option>
                        <option value="Indonesian">Indonesian</option>
                        <option value="Swahili">Swahili</option>
                    </select>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="editUserFiles" name="allow_files">
                    <label for="editUserFiles">File Permissions</label>
                </div>
                <button type="submit" class="btn">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Agent Configuration Modal -->
    <div id="agentConfigModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Configure Agent</h3>
                <button class="close-btn" onclick="closeModal('agentConfigModal')">&times;</button>
            </div>
            <form id="agentConfigForm">
                <input type="hidden" id="configTenant" name="tenant">
                <input type="hidden" id="configAgent" name="agent">
                
                <div class="widget-config">
                    <div class="config-section">
                        <h4>Basic Settings</h4>
                        <div class="form-group">
                            <label for="botName">Bot Name</label>
                            <input type="text" id="botName" name="bot_name" required>
                        </div>
                        <div class="form-group">
                            <label for="systemPrompt">System Prompt</label>
                            <textarea id="systemPrompt" name="system_prompt" rows="4" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="avatarUrl">Avatar URL</label>
                            <input type="url" id="avatarUrl" name="avatar_url">
                        </div>
                        <div class="form-group">
                            <label for="placeholderText">Input Placeholder</label>
                            <input type="text" id="placeholderText" name="placeholder_text" placeholder="Please ask your question...">
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h4>Widget Appearance</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="primaryColor">Primary Color</label>
                                <input type="color" id="primaryColor" name="primary_color" class="color-input">
                            </div>
                            <div class="form-group">
                                <label for="secondaryColor">Secondary Color</label>
                                <input type="color" id="secondaryColor" name="secondary_color" class="color-input">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="widgetMode">Widget Mode</label>
                            <select id="widgetMode" name="mode">
                                <option value="inline">Inline</option>
                                <option value="popup">Popup</option>
                            </select>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="autoOpen" name="auto_open">
                            <label for="autoOpen">Auto-open widget</label>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h4>AI Configuration</h4>
                        <div class="form-group">
                            <label for="llmProvider">LLM Provider</label>
                            <select id="llmProvider" name="llm_provider">
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Anthropic</option>
                                <option value="vertexai">Google Vertex AI</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="llmModel">Model</label>
                            <select id="llmModel" name="llm_model">
                                <option value="gpt-4o-mini">GPT-4o Mini</option>
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="temperature">Temperature</label>
                            <input type="range" id="temperature" name="temperature" min="0" max="1" step="0.1" value="0.3">
                            <span id="tempValue">0.3</span>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="localOnly" name="local_only" checked>
                            <label for="localOnly">Local Data Only</label>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h4>Widget Features</h4>
                        <div class="checkbox-group">
                            <input type="checkbox" id="enableVoice" name="enable_voice" checked>
                            <label for="enableVoice">Voice Input</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="enableFiles" name="enable_files" checked>
                            <label for="enableFiles">File Attachments</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="enableTTS" name="enable_tts">
                            <label for="enableTTS">Text-to-Speech</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="enableDarkMode" name="enable_dark_mode" checked>
                            <label for="enableDarkMode">Dark Mode Toggle</label>
                        </div>
                        <div class="form-group">
                            <label for="allowedDomains">Allowed Domains (one per line)</label>
                            <textarea id="allowedDomains" name="allowed_domains" rows="3" placeholder="example.com&#10;*.subdomain.com&#10;* (for all domains)">*</textarea>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('agentConfigModal')">Cancel</button>
                    <button type="submit" class="btn">Save Configuration</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Test Widget Modal -->
    <div id="testWidgetModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Test Widget</h3>
                <button class="close-btn" onclick="closeModal('testWidgetModal')">&times;</button>
            </div>
            <div id="testWidgetContent">
                <p>Testing widget for: <span id="testingAgent"></span></p>
                <div id="testWidgetContainer" style="height: 400px; border: 1px solid #ddd; border-radius: 8px; position: relative;">
                    <!-- Widget will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Files Modal -->
    <div id="uploadModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Upload Documents</h3>
                <button class="close-btn" onclick="closeModal('uploadModal')">&times;</button>
            </div>
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="hidden" id="uploadTenant" name="tenant">
                <input type="hidden" id="uploadAgent" name="agent">
                <div class="form-group">
                    <label for="files">Select Files</label>
                    <input type="file" id="files" name="files" multiple accept=".pdf,.txt,.md,.docx,.pptx,.xlsx,.csv,.html">
                    <small>Supported formats: PDF, TXT, MD, DOCX, PPTX, XLSX, CSV, HTML</small>
                </div>
                <button type="submit" class="btn">
                    <span id="uploadSpinner" class="spinner hidden"></span>
                    Upload Files
                </button>
                <div id="uploadResult" class="hidden"></div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let authToken = localStorage.getItem('rag_auth_token');
        let currentUser = null;
        let usersCache = [];
        const styleDefaults = {
            primary: "#1E88E5",
            primaryDark: "#1976D2",
            secondary: "#4CAF50",
            danger: "#f44336",
            warning: "#FF9800",
            footerBg: "#424242",
            bodyFontSize: 16,
            logoUrl: "https://www.craftedquery.com/logo.svg",
            footerLink1Text: "About us",
            footerLink1Url: "https://www.craftedquery.com/about",
            footerLink2Text: "Contact us",
            footerLink2Url: "https://www.craftedquery.com/contact",
            footerLink3Text: "Status",
            footerLink3Url: "https://www.craftedquery.com/status"
        };
        let userTimeoutMinutes = parseInt(localStorage.getItem("user_timeout_minutes")) || 30;
        let inactivityTimer = null;
        const API_BASE = window.location.origin;

        function applyCustomStyles() {
            Object.keys(styleDefaults).forEach(key => {
                const stored = localStorage.getItem("style_" + key) || styleDefaults[key];
                if (key === "bodyFontSize") {
                    document.documentElement.style.setProperty("--body-font-size", stored + "px");
                    const fs = document.getElementById("bodyFontSize");
                    if (fs) fs.value = stored;
                } else if (key === "logoUrl" || key.startsWith("footerLink")) {
                    const el = document.getElementById(key);
                    if (el) el.value = stored;
                } else {
                    const cssVar = "--" + key.replace(/([A-Z])/g, "-$1").toLowerCase();
                    document.documentElement.style.setProperty(cssVar, stored);
                    const el = document.getElementById(key);
                    if (el) el.value = stored;
                }
            });

            const logo = document.getElementById("footerLogo");
            if (logo) logo.src = localStorage.getItem("style_logoUrl") || styleDefaults.logoUrl;

            const links = [
                {id: "footerLink1", text: "footerLink1Text", url: "footerLink1Url"},
                {id: "footerLink2", text: "footerLink2Text", url: "footerLink2Url"},
                {id: "footerLink3", text: "footerLink3Text", url: "footerLink3Url"}
            ];
            links.forEach(l => {
                const a = document.getElementById(l.id);
                if (a) {
                    a.textContent = localStorage.getItem("style_" + l.text) || styleDefaults[l.text];
                    a.href = localStorage.getItem("style_" + l.url) || styleDefaults[l.url];
                }
            });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken) {
                validateToken();
            }

            applyCustomStyles();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            // Create buttons
            document.getElementById('createTenantBtn').addEventListener('click', () => showModal('createTenantModal'));
            document.getElementById('createUserBtn').addEventListener('click', () => {
                document.getElementById('createUserForm').reset();
                loadTenantsForUser();
                showModal('createUserModal');
            });
            document.getElementById('llmTestBtn').addEventListener('click', runLlmTest);
            document.getElementById('llmLogsBtn').addEventListener('click', loadLlmLogs);
            
            // Forms
            document.getElementById('createTenantForm').addEventListener('submit', handleCreateTenant);
            document.getElementById('createUserForm').addEventListener('submit', handleCreateUser);
            document.getElementById('agentConfigForm').addEventListener('submit', handleSaveAgentConfig);
            document.getElementById('uploadForm').addEventListener('submit', handleFileUpload);
            document.getElementById('editUserForm').addEventListener('submit', handleEditUser);

            document.getElementById('newUserTenant').addEventListener('change', function() {
                loadAgentsForTenant(this.value);
            });
            document.getElementById('editUserTenant').addEventListener('change', function() {
                loadAgentsForTenantEdit(this.value);
            });

            document.getElementById('llmProvider').addEventListener('change', function() {
                loadModels(this.value, null);
            });
            
            // Temperature slider
            document.getElementById('temperature').addEventListener('input', function() {
                document.getElementById('tempValue').textContent = this.value;
            });
            
            // Analytics tenant selector
            document.getElementById('analyticsTenant').addEventListener('change', loadAnalytics);

            // User timeout configuration
            const timeoutInput = document.getElementById('userTimeout');
            timeoutInput.value = userTimeoutMinutes;
            timeoutInput.addEventListener('change', function() {
                userTimeoutMinutes = parseInt(this.value) || 30;
                localStorage.setItem('user_timeout_minutes', userTimeoutMinutes);
                resetInactivityTimer();
            });

            // Styling inputs
            ["primary","primaryDark","secondary","danger","warning","footerBg","bodyFontSize","logoUrl","footerLink1Text","footerLink1Url","footerLink2Text","footerLink2Url","footerLink3Text","footerLink3Url"].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener("change", () => {
                        localStorage.setItem("style_" + id, el.value);
                        applyCustomStyles();
                    });
                }
            });

            ['mousemove', 'keydown', 'click', 'scroll'].forEach(evt => {
                document.addEventListener(evt, resetInactivityTimer);
            });
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const spinner = document.getElementById('loginSpinner');
            const errorDiv = document.getElementById('loginError');
            
            spinner.classList.remove('hidden');
            errorDiv.classList.add('hidden');
            
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('/api/auth/local', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `email=${encodeURIComponent(formData.get('email'))}&password=${encodeURIComponent(formData.get('password'))}`
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    localStorage.setItem('rag_auth_token', authToken);
                    await loadUser();
                    showMainInterface();
                } else {
                    showError('loginError', 'Invalid email or password');
                }
            } catch (error) {
                showError('loginError', 'Login failed. Please try again.');
            } finally {
                spinner.classList.add('hidden');
            }
        }

        async function validateToken() {
            try {
                const response = await fetch(`${API_BASE}/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    await loadUser();
                    showMainInterface();
                } else {
                    handleUnauthorized();
                }
            } catch (error) {
                handleUnauthorized();
            }
        }

        async function loadUser() {
            try {
                const response = await fetch(`${API_BASE}/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('userWelcome').textContent = `Welcome, ${currentUser.username}!`;
                }
            } catch (error) {
                console.error('Failed to load user:', error);
            }
        }

        function logout() {
            clearTimeout(inactivityTimer);
            localStorage.removeItem('rag_auth_token');
            authToken = null;
            currentUser = null;
            showLoginPage();
        }

        function showLoginPage() {
            document.getElementById('loginForm').reset();
            const error = document.getElementById('loginError');
            if (error) error.classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainInterface').classList.add('hidden');
        }

        function showMainInterface() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainInterface').classList.remove('hidden');
            loadDashboard();
            resetInactivityTimer();
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            if (authToken) {
                inactivityTimer = setTimeout(() => {
                    handleUnauthorized();
                }, userTimeoutMinutes * 60 * 1000);
            }
        }

        function switchTab(tabName) {
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Hide all panels
            document.querySelectorAll('.content-panel').forEach(panel => {
                panel.classList.add('hidden');
            });

            // Show selected panel
            document.getElementById(`${tabName}Panel`).classList.remove('hidden');

            // Load content based on tab
            switch (tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'tenants':
                    loadTenants();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'analytics':
                    loadAnalyticsOptions();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        async function loadDashboard() {
            try {
                // Load tenants for count
                const tenantsResponse = await fetch(`${API_BASE}/tenants`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (tenantsResponse.ok) {
                    const tenants = await tenantsResponse.json();
                    document.getElementById('totalTenants').textContent = tenants.length;
                    
                    let totalAgents = 0;
                    tenants.forEach(tenant => totalAgents += tenant.agents.length);
                    document.getElementById('totalAgents').textContent = totalAgents;
                }

                // Load users count
                const usersResponse = await fetch(`${API_BASE}/users`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (usersResponse.ok) {
                    const users = await usersResponse.json();
                    document.getElementById('totalUsers').textContent = users.length;
                }

                // Load analytics for total chats
                const analyticsResponse = await fetch(`${API_BASE}/analytics`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (analyticsResponse.ok) {
                    const analytics = await analyticsResponse.json();
                    document.getElementById('totalChats').textContent = analytics.total_queries || 0;
                }
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        async function loadTenants() {
            try {
                const response = await fetch(`${API_BASE}/tenants`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const tenants = await response.json();
                    displayTenants(tenants);
                }
            } catch (error) {
                console.error('Failed to load tenants:', error);
            }
        }

        function displayTenants(tenants) {
            const container = document.getElementById('tenantsContainer');
            container.innerHTML = '';

            tenants.forEach(tenant => {
                const tenantCard = document.createElement('div');
                tenantCard.className = 'tenant-card';
                tenantCard.innerHTML = `
                    <div class="tenant-header">
                        <h3>${tenant.tenant}</h3>
                        <button class="btn btn-outline" onclick="createAgent('${tenant.tenant}')">+ Add Agent</button>
                    </div>
                    <div class="tenant-body">
                        <div class="agents-grid">
                            ${tenant.agents.map(agent => `
                                <div class="agent-card">
                                    <div class="agent-name">${agent}</div>
                                    <div class="agent-status status-ready">Ready</div>
                                    <div class="agent-actions">
                                        <button class="btn btn-small" onclick="configureAgent('${tenant.tenant}', '${agent}')">Configure</button>
                                        <button class="btn btn-small btn-secondary" onclick="testAgent('${tenant.tenant}', '${agent}')">Test</button>
                                        <button class="btn btn-small btn-warning" onclick="uploadFiles('${tenant.tenant}', '${agent}')">Upload</button>
                                        <button class="btn btn-small btn-outline" onclick="getEmbedCode('${tenant.tenant}', '${agent}')">Embed</button>
                                        <button class="btn btn-small btn-danger" onclick="deleteAgent('${tenant.tenant}', '${agent}')">Delete</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.appendChild(tenantCard);
            });
        }

        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/users`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const users = await response.json();
                    usersCache = users;
                    displayUsers(users);
                }
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        function displayUsers(users) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                const agentsText = !user.agents || user.agents.length === 0 || user.agents.includes('*') ? '*' : user.agents.join(', ');
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.tenant}</td>
                    <td>${agentsText}</td>
                    <td>${user.role}</td>
                    <td><input type="checkbox" class="filePermToggle" data-user="${user.username}" ${user.allow_files ? 'checked' : ''} ${(currentUser.role === 'admin' || currentUser.role === 'system_admin') ? '' : 'disabled'}></td>
                    <td>${user.disabled ? '❌ Disabled' : '✅ Active'}</td>
                    <td>
                        <button class="btn btn-small" onclick="editUser('${user.username}')">Edit</button>
                        ${user.username !== 'admin' ? `<button class="btn btn-small btn-danger" onclick="deleteUser('${user.username}')">Delete</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
                const checkbox = row.querySelector('.filePermToggle');
                if (checkbox) {
                    checkbox.addEventListener('change', () => {
                        updateFilePermission(user.username, checkbox.checked);
                    });
                }
            });
        }

        async function loadAnalyticsOptions() {
            try {
                const response = await fetch(`${API_BASE}/tenants`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const tenants = await response.json();
                    const select = document.getElementById('analyticsTenant');
                    select.innerHTML = '<option value="">Select Tenant</option>';
                    
                    tenants.forEach(tenant => {
                        const option = document.createElement('option');
                        option.value = tenant.tenant;
                        option.textContent = tenant.tenant;
                        select.appendChild(option);
                    });
                    loadAnalytics();
                }
            } catch (error) {
                console.error('Failed to load analytics options:', error);
            }
        }

        async function loadAnalytics() {
            const tenant = document.getElementById('analyticsTenant').value;
            const resultsDiv = document.getElementById('analyticsResults');
            
            if (!tenant) {
                resultsDiv.classList.add('hidden');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/analytics?tenant=${tenant}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayAnalytics(data);
                    resultsDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }

        function displayAnalytics(data) {
            const container = document.getElementById('analyticsResults');
            container.innerHTML = `
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-number">${data.total_queries || 0}</div>
                        <div class="stat-label">Total Queries</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.unique_sessions || 0}</div>
                        <div class="stat-label">Unique Sessions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.feedback?.average?.toFixed(1) || 'N/A'}</div>
                        <div class="stat-label">Avg Feedback</div>
                    </div>
                <div class="stat-card">
                    <div class="stat-number">${data.performance?.mean?.toFixed(2) || 'N/A'}s</div>
                    <div class="stat-label">Avg Response Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.storage_gb?.toFixed(2) || '0'}</div>
                    <div class="stat-label">Vector Store (GB)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.file_count || 0}</div>
                    <div class="stat-label">Files in Vector DB</div>
                </div>
            </div>
            `;
        }

        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    const health = await response.json();
                    document.getElementById('systemStatus').innerHTML = `
                        <p><strong>Status:</strong> ${health.status}</p>
                        <p><strong>Version:</strong> ${health.version}</p>
                        <p><strong>Last Updated:</strong> ${new Date(health.timestamp).toLocaleString()}</p>
                        <p><strong>OpenAI:</strong> ${health.openai}${health.openai_error ? ' - ' + health.openai_error : ''}</p>
                        <p><strong>Anthropic:</strong> ${health.anthropic}${health.anthropic_error ? ' - ' + health.anthropic_error : ''}</p>
                    `;
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        }

        async function runLlmTest() {
            const resultDiv = document.getElementById('llmTestResult');
            resultDiv.textContent = 'Running test...';
            try {
                const response = await fetch(`${API_BASE}/llm_test`, { method: 'POST' });
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.textContent = `${new Date(data.timestamp).toLocaleString()} - ${data.message}`;
                    resultDiv.textContent += ` | OpenAI: ${data.openai}`;
                    if (data.openai_error) resultDiv.textContent += ` (${data.openai_error})`;
                    resultDiv.textContent += ` | Anthropic: ${data.anthropic}`;
                    if (data.anthropic_error) resultDiv.textContent += ` (${data.anthropic_error})`;
                    loadSettings();
                } else {
                    resultDiv.textContent = 'Test failed';
                }
            } catch (err) {
                resultDiv.textContent = 'Test failed';
                console.error('LLM test error:', err);
            }
        }

        async function loadLlmLogs() {
            const container = document.getElementById('llmLogs');
            container.classList.remove('hidden');
            container.innerHTML = 'Loading...';
            try {
                const response = await fetch(`${API_BASE}/llm_logs?limit=25`);
                if (response.ok) {
                    const data = await response.json();
                    container.innerHTML = formatLlmLogs(data.logs);
                } else {
                    container.innerHTML = 'Failed to load logs';
                }
            } catch (error) {
                console.error('Failed to load logs:', error);
                container.innerHTML = 'Failed to load logs';
            }
        }

        function formatLlmLogs(logs) {
            if (!logs.length) {
                return '<p>No logs found.</p>';
            }
            const rows = logs.map(log => `
                <tr>
                    <td>${new Date(log.ts).toLocaleString()}</td>
                    <td>${log.provider}</td>
                    <td>${log.status}</td>
                    <td>${log.tenant || ''}</td>
                    <td>${log.agent || ''}</td>
                    <td>${log.model || ''}</td>
                    <td>${log.description ? log.description : (log.error ? 'error: ' + log.error : '')}</td>
                    <td>${log.answer || ''}</td>
                </tr>
            `).join('');
            return `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Provider</th>
                                <th>Status</th>
                                <th>Tenant</th>
                                <th>Agent</th>
                                <th>Model</th>
                                <th>Description</th>
                                <th>Answer</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        async function loadModels(provider, currentModel) {
            const select = document.getElementById('llmModel');
            select.innerHTML = '<option>Loading...</option>';
            let models = [];
            try {
                const resp = await fetch(`${API_BASE}/llm_models?provider=${provider}`);
                if (resp.ok) {
                    const data = await resp.json();
                    models = data.models || [];
                }
            } catch (err) {
                console.error('Failed to load models', err);
            }

            select.innerHTML = '';
            models.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                select.appendChild(opt);
            });

            if (currentModel) {
                let found = models.includes(currentModel);
                if (!found) {
                    const opt = document.createElement('option');
                    opt.value = currentModel;
                    opt.textContent = currentModel;
                    select.appendChild(opt);
                }
                select.value = currentModel;
            }
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Tenant management
        async function handleCreateTenant(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const tenantName = formData.get('tenantName');
            const agentName = formData.get('agentName');

            try {
                // Create tenant directory and agent config via API
                const configData = {
                    bot_name: `${tenantName} ${agentName} Bot`,
                    system_prompt: `You are a helpful assistant for ${tenantName}.`,
                    primary_color: '#1E88E5',
                    secondary_color: '#FFFFFF',
                    placeholder_text: 'Please ask your question...'
                };

                const response = await fetch(`${API_BASE}/config?tenant=${tenantName}&agent=${agentName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });

                if (response.ok) {
                    closeModal('createTenantModal');
                    loadTenants();
                    showSuccess('Tenant created successfully!');
                } else {
                    showError('createTenantError', 'Failed to create tenant');
                }
            } catch (error) {
                showError('createTenantError', 'Failed to create tenant');
            }
        }

        async function createAgent(tenant) {
            const agentName = prompt('Enter agent name:');
            if (!agentName) return;

            try {
                const configData = {
                    bot_name: `${tenant} ${agentName} Bot`,
                    system_prompt: `You are a helpful assistant for ${tenant}.`,
                    primary_color: '#1E88E5',
                    secondary_color: '#FFFFFF',
                    placeholder_text: 'Please ask your question...'
                };

                const response = await fetch(`${API_BASE}/config?tenant=${tenant}&agent=${agentName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });

                if (response.ok) {
                    loadTenants();
                    showSuccess('Agent created successfully!');
                }
            } catch (error) {
                console.error('Failed to create agent:', error);
            }
        }

        // Agent configuration
        async function configureAgent(tenant, agent) {
            try {
                // Load current configuration (full details)
                const response = await fetch(`${API_BASE}/config/full?tenant=${tenant}&agent=${agent}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const config = await response.json();
                    await populateAgentConfig(tenant, agent, config);
                    showModal('agentConfigModal');
                }
            } catch (error) {
                console.error('Failed to load agent config:', error);
            }
        }

        async function populateAgentConfig(tenant, agent, config) {
            document.getElementById('configTenant').value = tenant;
            document.getElementById('configAgent').value = agent;
            document.getElementById('botName').value = config.bot_name || '';
            document.getElementById('systemPrompt').value = config.system_prompt || '';
            document.getElementById('avatarUrl').value = config.avatar_url || '';
            document.getElementById('placeholderText').value = config.placeholder_text || 'Please ask your question...';
            document.getElementById('primaryColor').value = config.primary_color || '#1E88E5';
            document.getElementById('secondaryColor').value = config.secondary_color || '#FFFFFF';
            document.getElementById('widgetMode').value = config.mode || 'inline';
            document.getElementById('autoOpen').checked = config.auto_open || false;
            document.getElementById('llmProvider').value = config.llm_provider || 'openai';
            await loadModels(document.getElementById('llmProvider').value, config.llm_model || 'gpt-4o-mini');
            document.getElementById('temperature').value = config.temperature || 0.3;
            document.getElementById('tempValue').textContent = config.temperature || 0.3;
            document.getElementById('localOnly').checked = config.local_only !== false;
            document.getElementById('enableVoice').checked = config.enable_voice !== false;
            document.getElementById('enableFiles').checked = config.enable_files !== false;
            document.getElementById('enableTTS').checked = config.enable_tts || false;
            document.getElementById('enableDarkMode').checked = config.enable_dark_mode !== false;
            
            const domains = Array.isArray(config.allowed_domains) ? config.allowed_domains.join('\n') : '*';
            document.getElementById('allowedDomains').value = domains;
        }

        async function handleSaveAgentConfig(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const tenant = formData.get('tenant');
            const agent = formData.get('agent');
            
            const configData = {
                bot_name: formData.get('bot_name'),
                system_prompt: formData.get('system_prompt'),
                avatar_url: formData.get('avatar_url'),
                primary_color: formData.get('primary_color'),
                secondary_color: formData.get('secondary_color'),
                mode: formData.get('mode'),
                auto_open: formData.has('auto_open'),
                llm_provider: formData.get('llm_provider'),
                llm_model: formData.get('llm_model'),
                temperature: parseFloat(formData.get('temperature')),
                local_only: formData.has('local_only'),
                enable_voice: formData.has('enable_voice'),
                enable_files: formData.has('enable_files'),
                enable_tts: formData.has('enable_tts'),
                enable_dark_mode: formData.has('enable_dark_mode'),
                allowed_domains: formData.get('allowed_domains').split('\n').map(d => d.trim()).filter(d => d),
                placeholder_text: formData.get('placeholder_text') || 'Please ask your question...'
            };

            try {
                const response = await fetch(`${API_BASE}/config?tenant=${tenant}&agent=${agent}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });

                if (response.ok) {
                    closeModal('agentConfigModal');
                    showSuccess('Agent configuration saved successfully!');
                } else {
                    showError('agentConfigError', 'Failed to save configuration');
                }
            } catch (error) {
                showError('agentConfigError', 'Failed to save configuration');
            }
        }

        // User management
        async function loadTenantsForUser() {
            try {
                const response = await fetch(`${API_BASE}/tenants`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const tenants = await response.json();
                    const select = document.getElementById('newUserTenant');

                    // Clear existing options
                    select.innerHTML = '';

                    if (currentUser.role === 'system_admin') {
                        const optAll = document.createElement('option');
                        optAll.value = '*';
                        optAll.textContent = 'All Tenants (Admin)';
                        select.appendChild(optAll);
                    }

                    tenants.forEach(tenant => {
                        const option = document.createElement('option');
                        option.value = tenant.tenant;
                        option.textContent = tenant.tenant;
                        select.appendChild(option);
                    });

                    loadAgentsForTenant(select.value);
                }
            } catch (error) {
                console.error('Failed to load tenants for user:', error);
            }
        }

        async function loadAgentsForTenant(tenant) {
            const select = document.getElementById('newUserAgent');
            if (!select) return;
            select.innerHTML = '';

            const optAll = document.createElement('option');
            optAll.value = '*';
            optAll.textContent = 'All Agents';
            select.appendChild(optAll);

            if (!tenant || tenant === '*') {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tenants`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const tenants = await response.json();
                    const t = tenants.find(t => t.tenant === tenant);
                    if (t) {
                        t.agents.forEach(agent => {
                            const option = document.createElement('option');
                            option.value = agent;
                            option.textContent = agent;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load agents for user:', error);
            }
        }

        async function loadTenantsForEditUser() {
            try {
                const response = await fetch(`${API_BASE}/tenants`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const tenants = await response.json();
                    const select = document.getElementById('editUserTenant');
                    if (!select) return;
                    select.innerHTML = '';

                    if (currentUser.role === 'system_admin') {
                        const optAll = document.createElement('option');
                        optAll.value = '*';
                        optAll.textContent = 'All Tenants (Admin)';
                        select.appendChild(optAll);
                    }

                    tenants.forEach(tenant => {
                        const option = document.createElement('option');
                        option.value = tenant.tenant;
                        option.textContent = tenant.tenant;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load tenants for user:', error);
            }
        }

        async function loadAgentsForTenantEdit(tenant) {
            const select = document.getElementById('editUserAgent');
            if (!select) return;
            select.innerHTML = '';

            const optAll = document.createElement('option');
            optAll.value = '*';
            optAll.textContent = 'All Agents';
            select.appendChild(optAll);

            if (!tenant || tenant === '*') {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tenants`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const tenants = await response.json();
                    const t = tenants.find(t => t.tenant === tenant);
                    if (t) {
                        t.agents.forEach(agent => {
                            const option = document.createElement('option');
                            option.value = agent;
                            option.textContent = agent;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load agents for user:', error);
            }
        }

        async function handleCreateUser(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userData = {
                username: formData.get('username'),
                password: formData.get('password'),
                tenant: formData.get('tenant'),
                agents: [formData.get('agent')],
                role: formData.get('role'),
                disabled: false,
                allow_files: formData.get('allow_files') === 'on',
                language: formData.get('language')
            };

            try {
                const response = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                if (response.ok) {
                    closeModal('createUserModal');
                    loadUsers();
                    showSuccess('User created successfully!');
                    e.target.reset();
                } else {
                    const error = await response.json();
                    showError('createUserError', error.detail || 'Your permissions are not sufficient to complete this action');
                }
            } catch (error) {
                showError('createUserError', 'Your permissions are not sufficient to complete this action');
            }
        }

        async function editUser(username) {
            const user = usersCache.find(u => u.username === username);
            if (!user) return;

            document.getElementById('editUserForm').reset();
            await loadTenantsForEditUser();
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editUserTenant').value = user.tenant;
            await loadAgentsForTenantEdit(user.tenant);
            const agentSelect = document.getElementById('editUserAgent');
            if (user.agents && user.agents.length > 0) {
                agentSelect.value = user.agents[0];
            } else {
                agentSelect.value = '*';
            }
            document.getElementById('editUserRole').value = user.role;
            const langSelect = document.getElementById('editUserLanguage');
            if (langSelect) {
                langSelect.value = user.language || 'English';
            }
            document.getElementById('editUserFiles').checked = !!user.allow_files;
            showModal('editUserModal');
        }

        async function handleEditUser(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const username = formData.get('username');
            const updateData = {
                tenant: formData.get('tenant'),
                agents: [formData.get('agent')],
                role: formData.get('role'),
                allow_files: formData.get('allow_files') === 'on',
                language: formData.get('language')
            };
            if (formData.get('password')) {
                updateData.password = formData.get('password');
            }

            try {
                const response = await fetch(`${API_BASE}/users/${username}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    closeModal('editUserModal');
                    loadUsers();
                    showSuccess('User updated successfully!');
                } else {
                    const error = await response.json();
                    showError('editUserError', error.detail || 'Failed to update user');
                }
            } catch (error) {
                showError('editUserError', 'Failed to update user');
            }
        }

        async function updateFilePermission(username, allowFiles) {
            try {
                const response = await fetch(`${API_BASE}/users/${username}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ allow_files: allowFiles })
                });

                if (response.ok) {
                    showSuccess('Permissions updated');
                } else {
                    showError('usersError', 'Failed to update permissions');
                    loadUsers();
                }
            } catch (error) {
                console.error('Failed to update permissions:', error);
                loadUsers();
            }
        }

        async function deleteUser(username) {
            if (!confirm(`Are you sure you want to delete user "${username}"?`)) return;

            try {
                const response = await fetch(`${API_BASE}/users/${username}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    loadUsers();
                    showSuccess('User deleted successfully!');
                }
            } catch (error) {
                console.error('Failed to delete user:', error);
            }
        }

        async function deleteAgent(tenant, agent) {
            if (!confirm(`Are you sure you want to delete agent "${agent}"?`)) return;

            try {
                const response = await fetch(`${API_BASE}/agents/${tenant}/${agent}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    loadTenants();
                    showSuccess('Agent deleted successfully!');
                } else {
                    const err = await response.json();
                    alert(err.detail || 'Failed to delete agent');
                }
            } catch (error) {
                console.error('Failed to delete agent:', error);
            }
        }

        // Agent actions
        function testAgent(tenant, agent) {
            document.getElementById('testingAgent').textContent = `${tenant}/${agent}`;
            
            // Clear previous widget
            const container = document.getElementById('testWidgetContainer');
            container.innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <p>Testing ${agent} agent...</p>
                    <p><small>The widget will appear here</small></p>
                </div>
            `;
            
            // Inject widget script
            const script = document.createElement('script');
            script.src = `${API_BASE}/widget.js?tenant=${tenant}&agent=${agent}`;
            script.onload = () => {
                // Widget should now be initialized
                console.log('Widget loaded for testing');
            };
            container.appendChild(script);
            
            showModal('testWidgetModal');
        }

        function uploadFiles(tenant, agent) {
            document.getElementById('uploadTenant').value = tenant;
            document.getElementById('uploadAgent').value = agent;
            showModal('uploadModal');
        }

        async function handleFileUpload(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const spinner = document.getElementById('uploadSpinner');
            const resultDiv = document.getElementById('uploadResult');
            
            spinner.classList.remove('hidden');
            resultDiv.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE}/upload?tenant=${formData.get('tenant')}&agent=${formData.get('agent')}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                const result = await response.json();

                if (response.status === 401) {
                    handleUnauthorized('uploadResult');
                } else if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">${result.message}</div>`;
                    resultDiv.classList.remove('hidden');
                    e.target.reset();
                } else {
                    resultDiv.innerHTML = `<div class="error">${result.detail || 'Upload failed'}</div>`;
                    resultDiv.classList.remove('hidden');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Upload failed</div>`;
                resultDiv.classList.remove('hidden');
            } finally {
                spinner.classList.add('hidden');
            }
        }

        function getEmbedCode(tenant, agent) {
            const embedCode = `<script src="${API_BASE}/widget.js?tenant=${tenant}&agent=${agent}"><\/script>`;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Embed Code</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="form-group">
                        <label>Copy this code to your website:</label>
                        <textarea readonly style="width: 100%; height: 100px; margin: 10px 0;">${embedCode}</textarea>
                        <button class="btn" onclick="navigator.clipboard.writeText('${embedCode}'); alert('Copied to clipboard!')">Copy to Clipboard</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-remove modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Utility functions
        function handleUnauthorized(elementId) {
            const message = 'Please log in again, your session has expired after 10 minutes inactive.';
            logout();
            if (elementId) {
                showError(elementId, message);
            } else {
                alert(message);
            }
        }
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.classList.remove('hidden');
            } else {
                alert(message);
            }
        }

        function showSuccess(message) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--secondary);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                font-weight: 600;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
<footer>
    <img id="footerLogo" src="https://www.craftedquery.com/logo.svg" alt="Crafted Query Logo"> 2025 © Crafted Query. All rights reserved. -
    <a id="footerLink1" href="https://www.craftedquery.com/about">About us</a> -
    <a id="footerLink2" href="https://www.craftedquery.com/contact">Contact us</a> -
    <a id="footerLink3" href="https://www.craftedquery.com/status">Status</a>.
</footer>
</body>
</html>
                    