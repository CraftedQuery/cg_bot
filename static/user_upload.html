<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Files</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:#f5f5f5; color:#424242; line-height:1.6; padding:40px; }
        .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .drop-zone { border:2px dashed #1E88E5; border-radius:12px; padding:60px; text-align:center; background:#fff; cursor:pointer; }
        .drop-zone.hover { background:#e0e0e0; }
        .btn { margin-top:20px; padding:12px 24px; background:#1E88E5; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
        .btn-small { padding:6px 12px; font-size:12px; margin-top:0; }
        table { width:100%; margin-top:20px; border-collapse:collapse; }
        th, td { padding:8px; border-bottom:1px solid #e0e0e0; text-align:left; }
        .hidden { display:none; }
        #replacePrompt { margin-top:20px; }
        #replacePrompt button { margin-right:10px; }
    </style>
</head>
<body>
    <div class="header">
        <h2>Upload Files</h2>
        <button id="homeBtn" class="btn btn-small" type="button">Home</button>
    </div>
    <div id="dropZone" class="drop-zone">Drag and Drop files here<br>or<br><button id="fileSelect" class="btn" type="button">Click to upload</button></div>
    <input type="file" id="fileInput" multiple class="hidden" />
    <div id="result" style="margin-top:20px"></div>
    <div id="replacePrompt" class="hidden">
        <span id="replaceMessage"></span><br>
        <button id="replaceBtn" class="btn" type="button">Replace</button>
        <button id="abortBtn" class="btn" type="button">Abort</button>
    </div>

<script>
const params = new URLSearchParams(window.location.search);
const tenant = params.get('tenant');
const agent = params.get('agent');
const API_BASE = '';
const authToken = localStorage.getItem('rag_auth_token');
let currentUser = null;

init();

async function init(){
    const res = await fetch(`${API_BASE}/users/me`,{headers:{Authorization:`Bearer ${authToken}`}});
    if(res.ok){
        currentUser = await res.json();
        if(!currentUser.allow_files){
            document.body.innerHTML = '<p>File access is disabled for your account.</p>';
            return;
        }
    }
}

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const result = document.getElementById('result');
const replacePrompt = document.getElementById('replacePrompt');
const replaceMessage = document.getElementById('replaceMessage');
const replaceBtn = document.getElementById('replaceBtn');
const abortBtn = document.getElementById('abortBtn');
document.getElementById('homeBtn').onclick = () => { window.location.href = '/user.html'; };
let pendingFiles = null;

replaceBtn.addEventListener('click', async () => {
    replacePrompt.classList.add('hidden');
    if(pendingFiles){
        await uploadFiles(pendingFiles, true);
        pendingFiles = null;
    }
});

abortBtn.addEventListener('click', () => {
    replacePrompt.classList.add('hidden');
    pendingFiles = null;
    result.textContent = 'Upload canceled';
});

fileInput.addEventListener('change', () => uploadFiles(fileInput.files));
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('hover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('hover'));
dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('hover'); uploadFiles(e.dataTransfer.files); });
document.getElementById('fileSelect').addEventListener('click', () => fileInput.click());

async function uploadFiles(files, replace=false){
    if(!files.length || (currentUser && !currentUser.allow_files)) return;
    const fileArr = Array.from(files);
    const totalFiles = fileArr.length;
    const totalSize = fileArr.reduce((n,f)=>n+f.size,0);
    let uploaded = 0;

    for(let i=0; i<fileArr.length; i++){
        const file = fileArr[i];
        const url = `${API_BASE}/upload?tenant=${tenant}&agent=${agent}${replace ? '&replace=true' : ''}`;
        const fd = new FormData();
        fd.append('files', file);

        result.textContent = `Uploading ${i+1} of ${totalFiles}... (${(uploaded/1048576).toFixed(1)}MB/${(totalSize/1048576).toFixed(1)}MB)`;

        const res = await fetch(url,{ method:'POST', headers:{ 'Authorization':`Bearer ${authToken}` }, body:fd });
        if(res.status === 409 && !replace){
            const data = await res.json().catch(()=>({detail:'File exists'}));
            pendingFiles = fileArr.slice(i);
            replaceMessage.textContent = data.detail;
            replacePrompt.classList.remove('hidden');
            return;
        }
        if(!res.ok){
            const data = await res.json().catch(()=>({detail:'Upload failed'}));
            result.textContent = data.detail || 'Upload failed';
            return;
        }
        uploaded += file.size;
    }

    result.textContent = `Upload successful (${(uploaded/1048576).toFixed(1)}MB/${(totalSize/1048576).toFixed(1)}MB)`;
    fileInput.value = '';
}
</script>
</body>
</html>
