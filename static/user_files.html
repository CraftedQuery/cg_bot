<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Files</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:#f5f5f5; color:#424242; line-height:1.6; padding:40px; }
        .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        table { width:100%; border-collapse:collapse; background:#fff; }
        th, td { padding:8px; border-bottom:1px solid #e0e0e0; }
        th { background:#e0e0e0; text-transform:uppercase; font-size:14px; }
        button { padding:6px 12px; border:none; border-radius:6px; background:#f44336; color:#fff; cursor:pointer; }
        .btn { display:inline-block; padding:12px 24px; background:#1E88E5; color:#fff; border:none; border-radius:8px; cursor:pointer; font-size:14px; font-weight:600; }
        .btn:hover { background:#1976D2; }
        .btn-small { padding:6px 12px; font-size:12px; }
        a { color:#1E88E5; text-decoration:none; }
    </style>
</head>
<body>
    <div class="header">
        <h2>Files</h2>
        <button id="homeBtn" class="btn btn-small" type="button">Home</button>
    </div>
    <table id="filesTable">
        <thead>
            <tr>
                <th id="sortName" style="cursor:pointer">Name</th>
                <th>Size</th>
                <th id="sortDate" style="cursor:pointer">Updated</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div id="pager" style="margin-top:10px"></div>
<script>
const params = new URLSearchParams(window.location.search);
const tenant = params.get('tenant');
const agent = params.get('agent');
const API_BASE = '';
const authToken = localStorage.getItem('rag_auth_token');
const tbody = document.querySelector('#filesTable tbody');
let currentUser = null;
let filesData = [];
let currentPage = 1;
const pageSize = 25;
let sortField = 'date';
let sortAsc = false;
document.getElementById('homeBtn').onclick = () => { window.location.href = '/user.html'; };

init();

async function init(){
    const res = await fetch(`${API_BASE}/users/me`,{headers:{Authorization:`Bearer ${authToken}`}});
    if(res.ok){
        currentUser = await res.json();
        if(!currentUser.allow_files){
            document.body.innerHTML = '<p>File access is disabled for your account.</p>';
            return;
        }
    }
    load();
}
async function load(){
    const res = await fetch(`${API_BASE}/files?tenant=${tenant}&agent=${agent}`,{headers:{Authorization:`Bearer ${authToken}`}});
    if(res.ok){
        filesData = await res.json();
        currentPage = 1;
        render();
    }
}

async function del(id){
    if(currentUser && !currentUser.allow_files) return;
    if(!confirm('Delete file?')) return;
    const res = await fetch(`${API_BASE}/files/${id}`,{method:'DELETE', headers:{Authorization:`Bearer ${authToken}`}});
    if(res.ok) load();
}

function render(){
    let data = [...filesData];
    data.sort((a,b)=>{
        if(sortField==='name'){
            return sortAsc ? a.filename.localeCompare(b.filename) : b.filename.localeCompare(a.filename);
        }else{
            return sortAsc ? new Date(a.uploaded_at)-new Date(b.uploaded_at) : new Date(b.uploaded_at)-new Date(a.uploaded_at);
        }
    });
    const start = (currentPage-1)*pageSize;
    const pageItems = data.slice(start,start+pageSize);
    tbody.innerHTML='';
    pageItems.forEach(f=>{
        const tr=document.createElement('tr');
        const fileUrl=`/uploaded/${tenant}/${agent}/${encodeURIComponent(f.filename)}?token=${encodeURIComponent(authToken)}`;
        tr.innerHTML=`<td><a href="${fileUrl}" target="_blank">${f.filename} \u2197</a></td>`+
                     `<td>${(f.size/1024).toFixed(1)} KB</td>`+
                     `<td>${new Date(f.uploaded_at).toLocaleString()}</td>`+
                     `<td>${f.status}</td>`+
                     `<td><button onclick="del(${f.id})">Delete</button></td>`;
        tbody.appendChild(tr);
    });
    const pages=Math.ceil(data.length/pageSize)||1;
    const pager=document.getElementById('pager');
    pager.innerHTML=`<button ${currentPage===1?'disabled':''} onclick="changePage(-1)">Prev</button> Page ${currentPage}/${pages} <button ${currentPage===pages?'disabled':''} onclick="changePage(1)">Next</button>`;
}

function changePage(delta){
    const pages=Math.ceil(filesData.length/pageSize)||1;
    currentPage=Math.min(pages,Math.max(1,currentPage+delta));
    render();
}

document.getElementById('sortName').addEventListener('click',()=>{sortField='name';sortAsc=!sortAsc;render();});
document.getElementById('sortDate').addEventListener('click',()=>{sortField='date';sortAsc=!sortAsc;render();});
</script>
</body>
</html>
