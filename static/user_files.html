<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Files</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:#f5f5f5; color:#424242; line-height:1.6; padding:40px; }
        table { width:100%; border-collapse:collapse; background:#fff; }
        th, td { padding:8px; border-bottom:1px solid #e0e0e0; }
        th { background:#e0e0e0; text-transform:uppercase; font-size:14px; }
        button { padding:6px 12px; border:none; border-radius:6px; background:#f44336; color:#fff; cursor:pointer; }
        a { color:#1E88E5; text-decoration:none; }
    </style>
</head>
<body>
    <h2>Files</h2>
    <table id="filesTable">
        <thead>
            <tr><th>Name</th><th>Size</th><th>Updated</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
    </table>
<script>
const params = new URLSearchParams(window.location.search);
const tenant = params.get('tenant');
const agent = params.get('agent');
const API_BASE = '';
const authToken = localStorage.getItem('rag_auth_token');
const tbody = document.querySelector('#filesTable tbody');
let currentUser = null;

init();

async function init(){
    const res = await fetch(`${API_BASE}/users/me`,{headers:{Authorization:`Bearer ${authToken}`}});
    if(res.ok){
        currentUser = await res.json();
        if(!currentUser.allow_files){
            document.body.innerHTML = '<p>File access is disabled for your account.</p>';
            return;
        }
    }
    load();
}
async function load(){
    const res = await fetch(`${API_BASE}/files?tenant=${tenant}&agent=${agent}`,{headers:{Authorization:`Bearer ${authToken}`}});
    if(res.ok){
        const data = await res.json();
        tbody.innerHTML = '';
        data.forEach(f => {
            const tr = document.createElement('tr');
            const fileUrl = `/uploaded/${tenant}/${agent}/${encodeURIComponent(f.filename)}?token=${encodeURIComponent(authToken)}`;
            tr.innerHTML = `<td><a href="${fileUrl}" target="_blank">${f.filename} \u2197</a></td>`+
                             `<td>${(f.size/1024).toFixed(1)} KB</td>`+
                             `<td>${new Date(f.uploaded_at).toLocaleString()}</td>`+
                             `<td>${f.status}</td>`+
                             `<td><button onclick="del(${f.id})">Delete</button></td>`;
            tbody.appendChild(tr);
        });
    }
}

async function del(id){
    if(currentUser && !currentUser.allow_files) return;
    if(!confirm('Delete file?')) return;
    const res = await fetch(`${API_BASE}/files/${id}`,{method:'DELETE', headers:{Authorization:`Bearer ${authToken}`}});
    if(res.ok) load();
}
</script>
</body>
</html>
